version: 2.1
orbs:
  git: opuscapita/git@0.0.3
  gcp-gcr: circleci/gcp-gcr@0.13.0

   
jobs: 
   build-linux:
     environment:
        BUILD_OUTPUT_DIR: "cmake-docker-build-debug"
        CLANG_VERSION: "1:10.0-50~exp1"
        GO_VERSION: "1.13.7"
        CMAKE_VERSION: "3.16.3-1ubuntu1"
        GCC_VERSION: "4:9.3.0-1ubuntu2"
        GFLAGS_VERSION: "2.2.2-1build1"
        JSONCPP_VERSION: "1.7.4-3.1ubuntu2"
        JSONRPCCPP_VERSION: "0.7.0-1build3"
        SCRYPT_VERSION: "1.21-3"
        GOROOT: "/usr/local/go"
        GOPATH: "/root/.go"
     docker:

      - image: gcr.io/$GOOGLE_PROJECT_ID/taraxa-node/builder
        auth:
          username: _json_key  # default username when using a JSON key file to authenticate
          password: $GCLOUD_SERVICE_KEY 
     resource_class: xlarge
     steps:
       - git/checkout-with-submodules
       - setup_remote_docker:
           docker_layer_caching: true
#       - run:
#          command: |
#              hexport PATH=$PATH:$GOPATH/bin:$GOROOT/bin && \
#              mkdir $BUILD_OUTPUT_DIR && cd $BUILD_OUTPUT_DIR &&  pwd && \
       - run: mkdir $BUILD_OUTPUT_DIR
       - run: | 
              cd $BUILD_OUTPUT_DIR &&
              cmake -DCMAKE_BUILD_TYPE=Debug \
              -DTARAXA_STATIC_BUILD=ON \
              -DTARAXAD_INSTALL_DIR=./bin_install \
              -DTARAXAD_CONF_INSTALL_DIR=./bin_install \
              ../ 
       - run: cd $BUILD_OUTPUT_DIR && make -j10 all 
       - run: cd $BUILD_OUTPUT_DIR && make install 
       - run: cd $BUILD_OUTPUT_DIR && strip bin_install/taraxad
       - run: cd $BUILD_OUTPUT_DIR/tests && ctest --output-on-failure
workflows:
  build-and-release:
    jobs:
      - gcp-gcr/build-and-push-image:
          executor: docker
          image: taraxa-node/taraxa-node-builder
          context: taraxa-node
          path: builder
          setup-remote-docker: true
          use-docker-layer-caching: true
      - build-linux:
           context: taraxa-node
           requires: [ gcp-gcr/build-and-push-image ]
#      - release-linux:
#          requires: 
#            - build-linux


