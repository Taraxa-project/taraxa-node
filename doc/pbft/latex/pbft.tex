\documentclass{article}
\usepackage{amsmath, amssymb, graphicx, hyperref}
\title{Taraxa PBFT}
\author{Version 1.0}
\date{February 01, 2025}

\begin{document}
    \maketitle

    \tableofcontents

    \section{Consensus Protocol}
    Taraxa consensus is based on Algorand pBFT algorithm.
    User $u$ starts new period $p$ the moment he receives 2t + 1 cert-votes for some value v and valid block $B_v$,
    he starts new round $r$ the moment he receives 2t + 1 next-votes for some value v or $\bot$ for round r - 1

    \subsection{Timing Parameters}
    \begin{itemize}
        \item $\lambda$ = 2000 ms: Intuitively corresponds to the time it takes for a small message (e.g., a vote) to propagate in good network conditions.
        \item $\lambda_1^{\text{min}}$ = 500 ms: Minimum time the dynamic algorithm allows for a small message to propagate under ideal conditions for round 1, reverting to $\lambda$ in future rounds if insufficient.
        \item $\lambda_1^{\text{max}}$ = 1500 ms: Maximum time the dynamic algorithm allows for a small message to propagate under ideal conditions for round 1, reverting to $\lambda$ in future rounds if insufficient.
        \item $\Lambda$ = 17000 ms: Time it takes for a big message (e.g., a block) to propagate in reasonable network conditions.
        \item $\Lambda_1$ = 4000 ms: Time it takes for a big message to propagate in good conditions for round 1, reverting to $\Lambda$ in future rounds if insufficient.
        \item $\lambda_r$: selected $\lambda$ value for current round
        \item $\Lambda_r$: selected $\Lambda$ value for current round
    \end{itemize}

    \subsection{Protocol Instructions}
    User $u$ starts period $p$ round 1 when he first sees 2t + 1 cert-votes for some value v and valid block $B_v$. If $u$ sees 2t + 1 next-votes for some value v or $\bot$, then $u$ starts new round $r' + 1$.

    Whenever $u$ starts a new period (or a new round), he resets $\text{timer}_u$, used to decide when to vote for each step.

    \subsection{Round (p, r) parameters values}
    When user $u$ starts round $(p, r)$, they reset their $\text{timer}_u$ to 0 and other constants as follows:

    \begin{itemize}
        \item If $r = 1$:
        \begin{itemize}
            \item $\lambda_r \in (\lambda_1^{\text{min}}, \lambda_1^{\text{max}})$
            \item $\Lambda_r = \Lambda_1$
            \item $st^r_u = \bot$
        \end{itemize}

        \item Otherwise if $r >= 2$:
        \begin{itemize}
            \item $\lambda_r = \lambda$
            \item $\Lambda_r = \Lambda$
            \item $st^r_u = v$
        \end{itemize}
    \end{itemize}

    \subsection{Round (p, r) Voting Instructions}
    The voting instructions are as follows:

    \begin{enumerate}

        \item[] Step 1: \textbf{Proposal} - When $\text{timer}_u = 0$:
        \begin{itemize}
            \item[--] If $r = 1$ or $r > 1$ and $u$ has received 2t+1 \text{ next-votes for } $\bot$ from round $(p, r - 1)$, then $u$ assembles a new block proposal $v_u$ and propagates $v_u$ together with his round r credential.
            \item[--] Otherwise, if $r > 1$ and $u$ has received 2t+1 \text{ next-votes for some value } v $\neq \bot$ from $(p, r-1)$, then $u$  proposes v, which he propagates together with his round r credential.
        \end{itemize}

        \item[] Step 2: \textbf{Filtering} - When $\text{timer}_u = 2\lambda_r$:
        \begin{itemize}
            \item[--] If $r = 1$ or if $r > 1$ and $u$ has received 2t+1 \text{ next-votes for } $\bot$, then $u$ selects the proposal with the minimum credential and soft-votes for it.
            \item[--] Otherwise, if $r > 1$ and $u$ has received 2t+1 \text{ next-votes for some value } v $\neq \bot$, then $u$ soft-votes for v.
        \end{itemize}

        \item[] Step 3: \textbf{Certifying} - While $\text{timer}_u \in (2\lambda_r, \max(4\lambda_r, \Lambda_r))$:
        \begin{itemize}
            \item[--] If $u$ receives 2t+1 \text{ soft-votes for some value } v $\neq \bot$ and a valid block $B_v$, then $u$ cert-votes v.
        \end{itemize}

        \item[] Step $s$ = 2$n$, where $n$ $\in (2, \infty)$: \textbf{First Finishing Step} - When $\text{timer}_u = \max(4\lambda_r, \Lambda_r) + (s-4)\lambda_r$:
        \begin{itemize}
            \item[--] If $u$ has certified some value $v$ for round $r$, he next-votes $v$.
            \item[--] Else if $(r \geq 2 \text{ and } i \text{ has seen } 2t+1 \text{ next-votes for } \bot \text{ for round } r-1)$, he next-votes $\bot$.
            \item[--] Else he next-votes his starting value $st^r_u$.
        \end{itemize}

        \item[] Step $s$ = 2$n$+1, where $n$ $\in (2, \infty)$: \textbf{Second Finishing Step} - When $\text{timer}_u = \max(4\lambda_r, \Lambda_r) + (s-5)\lambda_r$ + 100ms:
        \begin{itemize}
            \item[--] If $u$ sees $2t+1$ soft-votes for some value $v \neq \bot$ for round $r$, then $u$ next-votes $v$.
            \item[--] If $(r \geq 2 \text{ and } i \text{ sees } 2t+1 \text{ next-votes for } \bot \text{ for round } r-1 \text{ and } i \text{ has not certified in round } r)$, then $u$ next-votes $\bot$.
        \end{itemize}
        $\lambda_r$ is exponentially increased in each second finish step after reaching step 13, max value is 60000 ms

    \end{enumerate}

\end{document}
