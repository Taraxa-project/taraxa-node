name: Build Docker Image

on:
  push:
    branches:
      - master
      - develop
    paths-ignore:
      - 'doc/**'
      - '**.md'
      - 'charts/**'
  pull_request:
    branches:
      - master
      - develop
    paths-ignore:
      - 'doc/**'
      - '**.md'

env:
  REGISTRY: gcr.io
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  IMAGE_NAME: taraxa-node
  DOCKERFILE: Dockerfile

jobs:
  test:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Free disk space
        run: |
          df -h /
          sudo rm -rf /usr/lib/jvm \
                      /usr/local/.ghcup \
                      /usr/local/lib/android \
                      /usr/local/share/powershell \
                      /usr/share/dotnet \
                      /usr/share/swift \
                      "$AGENT_TOOLSDIRECTORY"
          sudo docker system prune -af || true
          df -h /

      - name: Build test image (build stage)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE }}
          target: build
          push: false
          load: true
          tags: taraxa-node-ctest:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run CTest
        run: |
          mkdir -p tmp_docker
          docker run --ulimit nofile=4096:4096 \
            --rm -v $PWD/tmp_docker:/tmp \
            --name taraxa-node-ctest \
            taraxa-node-ctest:test \
            sh -c 'cd cmake-docker-build/bin && ctest --output-on-failure'

      - name: Handle core dumps on failure
        if: failure()
        run: |
          if ls tmp_docker/core* 1> /dev/null 2>&1; then
            sudo chmod 777 tmp_docker/core*
          fi

      - name: Upload CTest artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ctest-artifacts
          path: tmp_docker/
          retention-days: 7

      - name: Build final image for SmokeTest
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE }}
          push: false
          load: true
          tags: taraxa-node:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run SmokeTest
        run: |
          # Create network
          docker network create smoketest

          # Start node
          docker run -d \
            --name smoketest \
            --net smoketest \
            taraxa-node:test \
            single

          # Wait for node to start
          sleep 30

          # Show logs
          echo "--- Container logs ---"
          docker logs smoketest
          echo "--- End logs ---"

          # Test RPC
          mkdir -p test_build-d
          http_code=$(docker run --rm -v $PWD/test_build-d:/data \
            --net smoketest \
            curlimages/curl:latest \
            -sS --fail -w '%{http_code}' -o /data/http.out \
            --url smoketest:7777 \
            -d '{
              "jsonrpc": "2.0",
              "id":"0",
              "method": "send_coin_transaction",
              "params":[{
                "nonce": 0,
                "value": 0,
                "gas": 0,
                "gas_price": 1,
                "receiver": "973ecb1c08c8eb5a7eaa0d3fd3aab7924f2838b0",
                "secret": "3800b2875669d9b2053c1aff9224ecfdc411423aac5b5a73d7a45ced1c3b9dcd"
              }]
            }')

          cat test_build-d/http.out || true

          if [ "$http_code" -eq 200 ]; then
            echo "SmokeTest passed!"
          else
            echo "SmokeTest failed with HTTP code: $http_code"
            exit 1
          fi

      - name: Save SmokeTest logs on failure
        if: failure()
        run: |
          mkdir -p smoketest-artifacts
          docker logs smoketest > smoketest-artifacts/container.log 2>&1 || true
          cp test_build-d/http.out smoketest-artifacts/ || true

      - name: Upload SmokeTest artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoketest-artifacts
          path: smoketest-artifacts/
          retention-days: 7

      - name: Cleanup SmokeTest
        if: always()
        run: |
          docker kill smoketest || true
          docker rm smoketest || true
          docker network rm smoketest || true

  build:
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    runs-on: ubuntu-latest
    outputs:
      image-digest: ${{ steps.build-push.outputs.digest }}
      image-tags: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.ARTIFACT_REGISTRY_SA_KEY }}

      - name: Set up Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Prepare environment variables
        id: prepare
        run: |
          COMMIT_SHA=${{ github.sha }}
          COMMIT_SHA_SHORT=${COMMIT_SHA:0:8}
          BUILD_NUMBER=${{ github.run_number }}
          PR_NUMBER=${{ github.event.pull_request.number }}

          # For PRs, use head.ref (the actual branch), for push events use ref_name
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH_NAME=${{ github.head.ref }}
          else
            BRANCH_NAME=${{ github.ref_name }}
          fi

          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "commit_sha_short=${COMMIT_SHA_SHORT}" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT

      - name: Generate image tags
        id: meta
        run: |
          REGISTRY_URL="${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}"
          TAGS=""

          if [ "${{ github.event_name }}" = "push" ]; then
            if [ "${{ steps.prepare.outputs.branch_name }}" = "develop" ]; then
              TAGS="${REGISTRY_URL}:develop-${{ steps.prepare.outputs.commit_sha_short }}"
              TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:develop-${{ steps.prepare.outputs.commit_sha }}"
              TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:develop-latest"
            elif [ "${{ steps.prepare.outputs.branch_name }}" = "master" ]; then
              TAGS="${REGISTRY_URL}:master-${{ steps.prepare.outputs.commit_sha_short }}"
              TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:master-latest"
            fi
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            TAGS="${REGISTRY_URL}:pr-${{ steps.prepare.outputs.pr_number }}-${{ steps.prepare.outputs.build_number }}"
          fi

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT

      - name: Free disk space
        if: runner.os == 'Linux'
        run: |
          df -h /
          sudo rm -rf /usr/lib/jvm \
                      /usr/local/.ghcup \
                      /usr/local/lib/android \
                      /usr/local/share/powershell \
                      /usr/share/dotnet \
                      /usr/share/swift \
                      "$AGENT_TOOLSDIRECTORY"
          sudo docker system prune -af || true
          df -h /
          
      - name: Build and push Docker image
        id: build-push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image build summary
        run: |
          echo "## Docker Image Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ steps.prepare.outputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ steps.prepare.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          # Convert comma-separated tags to markdown list
          IFS=',' read -ra TAGS <<< "${{ steps.meta.outputs.tags }}"
          for tag in "${TAGS[@]}"; do
            echo "- ${tag// /}" >> $GITHUB_STEP_SUMMARY
          done
          echo "**Image Digest:** ${{ steps.build-push.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
